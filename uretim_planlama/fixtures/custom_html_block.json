[
 {
  "docstatus": 0,
  "doctype": "Custom HTML Block",
  "html": "<style>\n  /* Tablo görünümü */\n  #tbl .table{font-size:12px}\n  #tbl .table td,#tbl .table th{padding:8px 10px;vertical-align:middle}\n  #tbl thead{position:sticky;top:0;z-index:10;background:#f8f9fa}\n\n  /* Toolbar */\n  .kesim-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}\n  .kesim-toolbar .frappe-control{min-width:160px}\n  .kesim-toolbar select#ptype{max-width:88px;min-width:88px;height:28px;padding:2px 6px}\n  .kesim-toolbar .btn{height:28px;line-height:1;padding:0 10px}\n\n  /* Bar görselleştirme (bar rengi sabit yeşil; over kırmızı) */\n  .bar-flex{display:flex;align-items:center;gap:10px}\n  .bar-wrap{position:relative;flex:1;height:14px;background:#edf2f7;border-radius:8px;overflow:hidden}\n  .bar-under{height:100%;background:linear-gradient(90deg,#43e97b 0%, #38f9d7 100%)} /* sabit yeşil */\n  .bar-over{position:absolute;top:0;height:100%;background:linear-gradient(90deg,#ff6b6b 0%, #ffa94d 100%)} /* 1400+ */\n  .bar-label{margin-left:auto;white-space:nowrap;font-weight:600;color:#1f2937}\n\n  /* İstasyon rozetleri (sadece ad hücresinde) */\n  .ws-badge{font-weight:600;padding:2px 8px;border-radius:12px;display:inline-block}\n  .ws-murat  {color:#1e40af;background:#e0f2fe;border:1px solid #93c5fd}   /* mavi */\n  .ws-kaban  {color:#9a3412;background:#fff7ed;border:1px solid #fdba74}   /* turuncu */\n  .ws-bottero{color:#5b21b6;background:#f3e8ff;border:1px solid #c4b5fd}   /* mor */\n  .ws-other  {color:#374151;background:#f3f4f6;border:1px solid #e5e7eb}   /* nötr */\n</style>\n\n<div class=\"p-2\">\n  <h5 style=\"margin:0 0 8px;font-weight:600;\">Günlük Kesim İstasyonu Tablosu</h5>\n\n  <div class=\"kesim-toolbar\">\n    <div id=\"from_ctrl\" class=\"frappe-control\"></div>\n    <div id=\"to_ctrl\"   class=\"frappe-control\"></div>\n    <select id=\"ptype\" class=\"form-control\" title=\"Üretim Türü\">\n      <option value=\"\">Tümü</option>\n      <option value=\"pvc\">PVC</option>\n      <option value=\"cam\">Cam</option>\n    </select>\n    <button id=\"reload\" class=\"btn btn-sm btn-primary\">Yükle</button>\n  </div>\n\n  <div id=\"tbl\"></div>\n</div>",
  "modified": "2025-10-07 13:22:34.731692",
  "name": "Günlük Kesim İstasyonu",
  "private": 0,
  "roles": [],
  "script": "// ERPNext tarih kontrolleri\nconst fromCtrl = frappe.ui.form.make_control({\n  df:{fieldtype:\"Date\",label:\"Başlangıç\",fieldname:\"from_date\"},\n  parent:root_element.querySelector(\"#from_ctrl\"), only_input:false\n});\nconst toCtrl = frappe.ui.form.make_control({\n  df:{fieldtype:\"Date\",label:\"Bitiş\",fieldname:\"to_date\"},\n  parent:root_element.querySelector(\"#to_ctrl\"), only_input:false\n});\nfromCtrl.make_input(); toCtrl.make_input();\n\nconst typeEl   = root_element.querySelector(\"#ptype\");\nconst reloadBtn= root_element.querySelector(\"#reload\");\nconst tbl      = root_element.querySelector(\"#tbl\");\n\n// Varsayılan aralık\n(function setDefaultRange(){\n  const today = frappe.datetime.get_today();\n  fromCtrl.set_value(frappe.datetime.add_days(today,-10));\n  toCtrl.set_value(frappe.datetime.add_days(today, 10));\n})();\n\nfunction ensureValidRange(){\n  const f=fromCtrl.get_value(), t=toCtrl.get_value();\n  if(!f||!t) return false;\n  const fd=frappe.datetime.str_to_obj(f), td=frappe.datetime.str_to_obj(t);\n  if(fd>td){ fromCtrl.set_value(t); toCtrl.set_value(f); }\n  return true;\n}\n\n// Tür filtresi\nfunction filterByType(rows,t){\n  if(!t) return rows;\n  if(t===\"pvc\") return rows.filter(r=>r.workstation&&(r.workstation.includes(\"Murat\")||r.workstation.includes(\"Kaban\")));\n  if(t===\"cam\") return rows.filter(r=>r.workstation&&r.workstation.includes(\"Bottero\"));\n  return rows;\n}\n\n// 0–1400 = %70, 1400+ = %30 ölçek\nfunction getWidths(mtul,maxTotal){\n  const BASE=70, EXTRA=30;\n  const under=Math.min(mtul,1400), over=Math.max(mtul-1400,0);\n  const underPct=(under/1400)*BASE;\n  const overPct = maxTotal>1400 ? Math.min((over/(maxTotal-1400))*EXTRA, EXTRA) : 0;\n  return { underPct: Math.min(underPct,70), overPct };\n}\n\n// İstasyon adını rozetle renklendir\nfunction wsBadge(ws){\n  const n = String(ws||'').toLowerCase();\n  let cls = 'ws-other';\n  if (n.includes('murat'))   cls = 'ws-murat';   // mavi\n  else if (n.includes('kaban')) cls = 'ws-kaban';   // turuncu\n  else if (n.includes('bottero')) cls = 'ws-bottero'; // mor\n  return `<span class=\"ws-badge ${cls}\">${ws || '-'}</span>`;\n}\n\nfunction render(rows){\n  if(!rows || rows.length===0){\n    tbl.innerHTML=`<div class=\"text-muted p-3\">Seçilen aralıkta veri yok</div>`;\n    return;\n  }\n  const maxTotal=Math.max(2000, ...rows.map(r=>Number(r.total_mtul||0)));\n  const body = rows\n    .sort((a,b)=>new Date(a.date)-new Date(b.date) || String(a.workstation).localeCompare(String(b.workstation)))\n    .map(r=>{\n      const mtul=Number(r.total_mtul||0), qty=Number(r.total_quantity||0);\n      const {underPct,overPct}=getWidths(mtul,maxTotal);\n      return `\n        <tr>\n          <td>${frappe.datetime.str_to_user(r.date)}</td>\n          <td>${wsBadge(r.workstation)}</td>\n          <td colspan=\"2\">\n            <div class=\"bar-flex\">\n              <div class=\"bar-wrap\">\n                <div class=\"bar-under\" style=\"width:${underPct}%;\"></div>\n                ${overPct>0?`<div class=\"bar-over\" style=\"left:${underPct}%;width:${overPct}%;\"></div>`:\"\"}\n              </div>\n              <div class=\"bar-label\">${mtul.toFixed(0)} MTUL • ${qty}</div>\n            </div>\n          </td>\n        </tr>`;\n    }).join(\"\");\n  tbl.innerHTML = `\n    <table class=\"table table-bordered table-sm\" style=\"width:100%;\">\n      <thead class=\"table-light\">\n        <tr>\n          <th style=\"width:140px;\">Tarih</th>\n          <th style=\"width:220px;\">İstasyon</th>\n          <th colspan=\"2\">Toplam MTUL / m² - Toplam Adet</th>\n        </tr>\n      </thead>\n      <tbody>${body}</tbody>\n    </table>`;\n}\n\nlet loading=false, tmr;\n\n// Manuel: Yükle\nreloadBtn.addEventListener(\"click\", load);\n\n// Otomatik: tarih/tür değişince\n[fromCtrl.$input,toCtrl.$input,typeEl].forEach(el=>{\n  (el instanceof HTMLElement?el:el[0]).addEventListener(\"change\",()=>{\n    clearTimeout(tmr); tmr=setTimeout(load,200);\n  });\n});\n\nasync function load(){\n  if(loading || !ensureValidRange()) return;\n  loading=true;\n  const oldText = reloadBtn.textContent;\n  reloadBtn.disabled=true; reloadBtn.textContent=\"Yükleniyor...\";\n\n  const from_date=fromCtrl.get_value(), to_date=toCtrl.get_value(), t=typeEl.value;\n  try{\n    const r = await frappe.xcall(\"uretim_planlama.uretim_planlama.api.get_daily_cutting_matrix\",{from_date,to_date});\n    const data = filterByType((r && r.message) ? r.message : (r || []), t);\n    render(data);\n  }catch(e){\n    console.error(e);\n    tbl.innerHTML=`<div class=\"text-danger p-3\">Hata: ${e.message||e}</div>`;\n  }finally{\n    loading=false; reloadBtn.disabled=false; reloadBtn.textContent=oldText;\n  }\n}\n\n// İlk yükleme\nload();",
  "style": "/* Tablo görünümü */\n#tbl .table { font-size: 12px; }\n#tbl .table td,\n#tbl .table th { padding: 8px 10px; vertical-align: middle; }\n#tbl thead { position: sticky; top: 0; z-index: 10; background: #f8f9fa; }\n\n/* Toolbar */\n.kesim-toolbar { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-bottom: 10px; }\n.kesim-toolbar .frappe-control { min-width: 160px; }\n.kesim-toolbar select#ptype { max-width: 88px; min-width: 88px; height: 28px; padding: 2px 6px; }\n.kesim-toolbar .btn { height: 28px; line-height: 1; padding: 0 10px; }\n\n/* Bar görselleştirme (bar rengi sabit yeşil; 1400+ kırmızı/turuncu) */\n.bar-flex { display: flex; align-items: center; gap: 10px; }\n.bar-wrap { position: relative; flex: 1; height: 14px; background: #edf2f7; border-radius: 8px; overflow: hidden; }\n.bar-under { height: 100%; background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%); } /* 0–1400 */\n.bar-over  { position: absolute; top: 0; height: 100%; background: linear-gradient(90deg, #ff6b6b 0%, #ffa94d 100%); } /* 1400+ */\n.bar-label { margin-left: auto; white-space: nowrap; font-weight: 600; color: #1f2937; }\n\n/* İstasyon rozetleri (yalnızca ad hücresinde) */\n.ws-badge { font-weight: 600; padding: 2px 8px; border-radius: 12px; display: inline-block; }\n.ws-murat   { color: #1e40af; background: #e0f2fe; border: 1px solid #93c5fd; } /* mavi */\n.ws-kaban   { color: #9a3412; background: #fff7ed; border: 1px solid #fdba74; } /* turuncu */\n.ws-bottero { color: #5b21b6; background: #f3e8ff; border: 1px solid #c4b5fd; } /* mor */\n.ws-other   { color: #374151; background: #f3f4f6; border: 1px solid #e5e7eb; } /* nötr */"
 }
]